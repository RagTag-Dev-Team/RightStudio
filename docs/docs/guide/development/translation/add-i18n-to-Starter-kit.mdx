import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

# Adding i18n to the Starter-Kit

:::note
Our template supports Right-to-Left (RTL) languages like Arabic and Left-to-Right (LTR) languages like English. By adding i18n, you enable the template to automatically switch between RTL and LTR layouts based on the selected language.
:::

### Step 1: Add Packages

Begin by installing packages related to i18n, which handle locale matching and negotiation. 

- `@formatjs/intl-localematcher`
- `@types/negotiator`
- `negotiator`
- `server-only`

Run the appropriate command in your project's root directory based on your package manager:

<Tabs>
  <TabItem value="pnpm">
    <CodeBlock language='bash'>pnpm install @formatjs/intl-localematcher @types/negotiator negotiator server-only</CodeBlock>
  </TabItem>
  <TabItem value="yarn">
    <CodeBlock language='bash'>yarn install @formatjs/intl-localematcher @types/negotiator negotiator server-only</CodeBlock>
  </TabItem>
  <TabItem value="npm">
    <CodeBlock language='bash'>npm install @formatjs/intl-localematcher @types/negotiator negotiator server-only</CodeBlock>
  </TabItem>
</Tabs>

### Step 2: Organize Content for Translation

1. In `src/app`, create a folder named `[lang]`.
2. Move all content from `src/app` to `[lang]`, excluding `src/app/api`, `favicon`, and `global.css`.
3. Update path references in the moved files.

### Step 3: Create i18n.ts File

In `src/configs`, create `i18n.ts` with the following content:

```ts
export const i18n = {
  defaultLocale: 'en',
  locales: ['en', 'fr', 'ar'],
  langDirection: {
    en: 'ltr',
    fr: 'ltr',
    ar: 'rtl'
  }
} as const

export type Locale = (typeof i18n)['locales'][number]
```

### Step 4: Create i18n.ts File in utils folder

In `src/utils`, create `i18n.ts` with the following content:

```ts
// Config Imports
import { i18n } from '@configs/i18n'

// Util Imports
import { ensurePrefix } from '@/utils/string'

// Check if the url is missing the locale
export const isUrlMissingLocale = (url: string) => {
  return i18n.locales.every(locale => !(url.startsWith(`/${locale}/`) || url === `/${locale}`))
}

// Get the localized url
export const getLocalizedUrl = (url: string, languageCode: string): string => {
  if (!url || !languageCode) throw new Error("URL or Language Code can't be empty")

  return isUrlMissingLocale(url) ? `/${languageCode}${ensurePrefix(url, '/')}` : url
}
```

### Step 5: Middleware File

:::warning Note
If you have implemented [Authentication](/docs/guide/authentication/add-auth) in Starter Kit, and you want to add i18n to your project, then you can copy the middleware file from the full-version of the template. The middleware file is located at `src/middleware.ts/js`.
:::

If you want to add only i18n in starter kit, then you have to create a `middleware.ts/js` file in the `src` folder and add the following code:

```ts
// Next Imports
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

// Third-party Imports
import Negotiator from 'negotiator'
import { match as matchLocale } from '@formatjs/intl-localematcher'

// Config Imports
import { i18n } from '@configs/i18n'

// Util Imports
import { getLocalizedUrl, isUrlMissingLocale } from '@/utils/i18n'
import { ensurePrefix } from '@/utils/string'

const getLocale = (request: NextRequest): string | undefined => {
  // Try to get locale from URL
  const urlLocale = i18n.locales.find(locale => request.nextUrl.pathname.startsWith(`/${locale}/`))

  if (urlLocale) return urlLocale

  // Negotiator expects plain object so we need to transform headers
  const negotiatorHeaders: Record<string, string> = {}

  request.headers.forEach((value, key) => (negotiatorHeaders[key] = value))

  // @ts-ignore locales are readonly
  const locales: string[] = i18n.locales

  // Use negotiator and intl-localematcher to get best locale
  const languages = new Negotiator({ headers: negotiatorHeaders }).languages(locales)

  const locale = matchLocale(languages, locales, i18n.defaultLocale)

  return locale
}

const localizedRedirect = (url: string, locale: string | undefined, request: NextRequest) => {
  let _url = url

  const isLocaleMissing = isUrlMissingLocale(_url)

  if (isLocaleMissing) {
    // e.g. incoming request is /products
    // The new URL is now /en/products
    _url = getLocalizedUrl(_url, locale ?? i18n.defaultLocale)
  }

  _url = ensurePrefix(_url, `${process.env.BASEPATH ?? ''}`)

  const redirectUrl = new URL(_url, request.url).toString()

  return NextResponse.redirect(redirectUrl)
}

export default async function middleware(request: NextRequest) {
  // Get locale from request headers
  const locale = getLocale(request)

  const pathname = request.nextUrl.pathname

  // If pathname already contains a locale, return next() else redirect with localized URL
  return isUrlMissingLocale(pathname) ? localizedRedirect(pathname, locale, request) : NextResponse.next()
}

// Matcher Config
export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - api (API routes)
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - all items inside the public folder
     *    - images (public images)
     *    - next.svg (Next.js logo)
     *    - vercel.svg (Vercel logo)
     */
    '/((?!api|_next/static|_next/image|favicon.ico|.+?/hook-examples|.+?/menu-examples|images|next.svg|vercel.svg).*)'
  ]
}
```

### Step 6: Manage Language Dictionaries

1. In `src/data`, create a `dictionaries` folder.
2. Create a json file for each language in the `dictionaries` folder. For example, `en.json`, `fr.json`, and `ar.json`.
3. For example in `en.json` file add the following code:

    ```json
    {
      "navigation": {
        "home": "Home",
        "about": "About"
      }
    }
    ```
    Similarly, you can add the dictionary for other languages as well.
4. Create a `get-dictionary.ts` file in the `src/utils` folder and add the following code:

    ```tsx
    // Third-party Imports
    import 'server-only'

    // Type Imports
    import type { Locale } from '@configs/i18n'

    const dictionaries = {
    en: () => import('@/data/dictionaries/en.json').then(module => module.default),
    ... // add other languages
    }

    export const getDictionary = async (locale: Locale) => dictionaries[locale]()
    ```

### Step 7: Integrating i18n in the Project

- Go to the `src/app/[lang]/layout.tsx` file and make the following changes.

  1. Add the following import:
      ```diff
      + import { i18n } from '@/configs/i18n'
      + import type { Locale } from '@/configs/i18n'
      ```
  2. Replace the following statement:

      ```diff
      - { children }: ChildrenType
      + { children, params }: ChildrenType & { params: { lang: Locale} }

      - const direction = 'ltr'
      + const direction = i18n.langDirection[params.lang]  

      - lang='en'
      + lang={params.lang}
      ```

      **Make the above changes in the files where you want to use `direction`**

- Go to the `src/app/[lang]/(dashboard)/layout.tsx` file and make the following changes.

  1. Make the same changes as you done in the `src/app/[lang]/layout.tsx` file.
  2. Additionally, add the following statement:

      ```diff
      + import { getDictionary } from '@/utils/get-dictionary'

      + const dictionary = await getDictionary(params.lang)
      ```
  3. Add the `dictionary={dictionary}` prop to the `<Navigation />` and `<Header />` components.

- Go to the `src/components/layout/vertical/Navigation.tsx` file and make the following changes.

  1. Add the following in props and get the dictionary from props.

      ```diff
      // If you have used props
      + import type { getDictionary } from '@/utils/get-dictionary'

      type Props = {
        ...
      + dictionary: Awaited<ReturnType<typeof getDictionary>>
      }

      // get the dictionary from props
      + const { dictionary } = props // get the dictionary with other props like this
      ```
      or
      ```diff
      + import type { getDictionary } from '@/utils/get-dictionary'

      // Direct passing the parameter
      + { dictionary }: { dictionary: Awaited<ReturnType<typeof getDictionary>> }
      ```
      You have to make the changes mentioned above in the following files as well:

      - `src/components/layout/vertical/VerticalMenu.tsx`

      - `src/components/layout/horizontal/Header.tsx`

      - `src/components/layout/horizontal/Navigation.tsx`

      - `src/components/layout/horizontal/HorizontalMenu.tsx`

- pass the `dictionary={dictionary}` prop to the in the following files:

  - `src/components/layout/vertical/Navigation.tsx` file in the `<VerticalMenu>` component.

  - `src/components/layout/horizontal/Navigation.tsx` file in the `<HorizontalMenu>` component.

  - `src/components/layout/horizontal/Header.tsx` file in the `<Navigation>` component.

- Make the following changes in `src/components/layout/vertical/VerticalMenu.tsx` and `src/components/layout/horizontal/HorizontalMenu.tsx` files. 

  1. Add the following code:

      ```diff
        // Next Imports
      + import { useParams } from 'next/navigation'

        // Hooks
      + const params = useParams()
      + const { lang: locale } = params
      ```

  2. Replace the following statement:

      ```diff
      -  <MenuItem href='/home' icon={<i className='ri-home-smile-line' />}>
      -    Home
      -  </MenuItem>
      -  <MenuItem href='/about' icon={<i className='ri-information-line' />}>
      -    About
      -  </MenuItem>

      +  <MenuItem href={`/${locale}/home`} icon={<i className='ri-home-smile-line' />}>
      +    {dictionary['navigation'].home}
      +  </MenuItem>
      +  <MenuItem href={`/${locale}/about`} icon={<i className='ri-information-line' />}>
      +    {dictionary['navigation'].about}
      +  </MenuItem>
      ```
    
- Go to the `src/components/layout/shared/Logo.tsx` file and make the following changes.

  1. Add the following code:

      ```diff
        // Next Imports
      + import { useParams } from 'next/navigation'

        // Hooks
      + const params = useParams()
      + const { lang: locale } = params
      ```

  2. Replace the following statement:

      ```diff
      -  <Link href='/'>
      +  <Link href={locale ? `/${locale}` : '/'}>
      ```


  :::warning Note
  If you are using dynamic routes in your project, then you have to add `/${locale}/` in the path in `src/data/navigation/verticalMenuData.tsx` and `src/data/navigation/horizontalMenuData.tsx` files like this:

  ```diff
  -  href: '/home',
  +  href: `/${locale}/home`,
  ```
  :::

  :::danger Note
  Please note that wherever you have used the `href` prop, you have to add the locale in the path. For example, if you have used `href='/home'` then you have to replace it with ``href={`/${locale}/home`}`` to add the locale in the path.
  :::

- Go to the `src/app/[lang]/page.tsx` file and make following changes:

  1. Add the following code:

      ```diff
        // Next Imports
      + import { useParams } from 'next/navigation'

        // Hooks
      + const params = useParams()
      + const { lang: locale } = params
      ```

  2. Replace the following statement:

      ```diff
      -  redirect('/home')
      +  redirect(`/${locale}/home`)
      ```

### Step 8: LanguageDropdown Component

- If you want to add a language dropdown in your project, then you may copy the `LanguageDropdown.tsx` file from the full-version of the template and modify as per your requirement. The file is located at `src/components/layout/shared/LanguageDropdown.tsx`.

- You need to import this component in the `src/components/layout/vertical/NavbarContent.tsx` and `src/components/layout/horizontal/NavbarContent.tsx` files like following:

  ```tsx
  import LanguageDropdown from '@components/layout/shared/LanguageDropdown'

  const NavbarContent = () => {
  return (
    <div>
      ...
      <div>
        <LanguageDropdown />
        <UserDropdown />
      </div>
    </div>
    )
  }
  export default NavbarContent
  ```

After completing these steps, if you encounter any type errors, try refreshing/reopening your editor or deleting the .next folder before running your project again.

Congratulations! You've successfully added i18n to your Next.js project. ðŸ¥³ðŸŽ‰
